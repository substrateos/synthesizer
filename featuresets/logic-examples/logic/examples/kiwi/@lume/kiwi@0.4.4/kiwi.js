/* esm.sh - @lume/kiwi@0.4.4 */
function _(){return new C}var C=class o{index={};array=[];size(){return this.array.length}empty(){return this.array.length===0}itemAt(t){return this.array[t]}contains(t){return this.index[t.id()]!==void 0}find(t){let e=this.index[t.id()];return e===void 0?void 0:this.array[e]}setDefault(t,e){let r=this.index[t.id()];if(r===void 0){let i=new S(t,e());return this.index[t.id()]=this.array.length,this.array.push(i),i}else return this.array[r]}insert(t,e){let r=new S(t,e),i=this.index[t.id()];return i===void 0?(this.index[t.id()]=this.array.length,this.array.push(r)):this.array[i]=r,r}erase(t){let e=this.index[t.id()];if(e===void 0)return;this.index[t.id()]=void 0;let r=this.array[e],i=this.array.pop();return r!==i&&(this.array[e]=i,this.index[i.first.id()]=e),r}copy(){let t=new o;for(let e=0;e<this.array.length;e++){let r=this.array[e].copy();t.array[e]=r,t.index[r.first.id()]=e}return t}},S=class o{first;second;constructor(t,e){this.first=t,this.second=e}copy(){return new o(this.first,this.second)}};var E=class{constructor(t=""){this._name=t}id(){return this._id}name(){return this._name}setName(t){this._name=t}context(){return this._context}setContext(t){this._context=t}value(){return this._value}setValue(t){this._value=t}plus(t){return new d(this,t)}minus(t){return new d(this,typeof t=="number"?-t:[-1,t])}multiply(t){return new d([t,this])}divide(t){return new d([1/t,this])}toJSON(){return{name:this._name,value:this._value}}toString(){return this._context+"["+this._name+":"+this._value+"]"}_name;_value=0;_context=null;_id=V++},V=0;var d=class o{constructor(){let t=j(arguments);this._terms=t.terms,this._constant=t.constant}terms(){return this._terms}constant(){return this._constant}value(){let t=this._constant;for(let e=0,r=this._terms.size();e<r;e++){let i=this._terms.itemAt(e);t+=i.first.value()*i.second}return t}plus(t){return new o(this,t)}minus(t){return new o(this,typeof t=="number"?-t:[-1,t])}multiply(t){return new o([t,this])}divide(t){return new o([1/t,this])}isConstant(){return this._terms.size()==0}toString(){let t=this._terms.array.map(function(e){return e.second+"*"+e.first.toString()}).join(" + ");return!this.isConstant()&&this._constant!==0&&(t+=" + "),t+=this._constant,t}_terms;_constant};function j(o){let t=0,e=()=>0,r=_();for(let i=0,s=o.length;i<s;++i){let n=o[i];if(typeof n=="number")t+=n;else if(n instanceof E)r.setDefault(n,e).second+=1;else if(n instanceof d){t+=n.constant();let a=n.terms();for(let l=0,h=a.size();l<h;l++){let f=a.itemAt(l);r.setDefault(f.first,e).second+=f.second}}else if(n instanceof Array){if(n.length!==2)throw new Error("array must have length 2");let a=n[0],l=n[1];if(typeof a!="number")throw new Error("array item 0 must be a number");if(l instanceof E)r.setDefault(l,e).second+=a;else if(l instanceof d){t+=l.constant()*a;let h=l.terms();for(let f=0,u=h.size();f<u;f++){let m=h.itemAt(f);r.setDefault(m.first,e).second+=m.second*a}}else throw new Error("array item 1 must be a variable or expression")}else throw new Error("invalid Expression argument: "+n)}return{terms:r,constant:t}}var p=class o{static create(t,e,r,i=1){let s=0;return s+=Math.max(0,Math.min(1e3,t*i))*1e6,s+=Math.max(0,Math.min(1e3,e*i))*1e3,s+=Math.max(0,Math.min(1e3,r*i)),s}static required=o.create(1e3,1e3,1e3);static strong=o.create(1,0,0);static medium=o.create(0,1,0);static weak=o.create(0,0,1);static clip(t){return Math.max(0,Math.min(o.required,t))}};var w;(function(o){o[o.Le=0]="Le",o[o.Ge=1]="Ge",o[o.Eq=2]="Eq"})(w||(w={}));var x=class{constructor(t,e,r,i=p.required){this._operator=e,this._strength=p.clip(i),r===void 0&&t instanceof d?this._expression=t:this._expression=t.minus(r)}id(){return this._id}expression(){return this._expression}op(){return this._operator}strength(){return this._strength}toString(){return this._expression.toString()+" "+["<=",">=","="][this._operator]+" 0 ("+this._strength.toString()+")"}_expression;_operator;_strength;_id=P++},P=0;var D=class{maxIterations=1e3;constructor(){}createConstraint(t,e,r,i=p.required){let s=new x(t,e,r,i);return this.addConstraint(s),s}addConstraint(t){if(this._cnMap.find(t)!==void 0)throw new Error("duplicate constraint");let r=this._createRow(t),i=r.row,s=r.tag,n=this._chooseSubject(i,s);if(n.type()===c.Invalid&&i.allDummies())if(k(i.constant()))n=s.marker;else throw new Error("unsatisfiable constraint");if(n.type()===c.Invalid){if(!this._addWithArtificialVariable(i))throw new Error("unsatisfiable constraint")}else i.solveFor(n),this._substitute(n,i),this._rowMap.insert(n,i);this._cnMap.insert(t,s),this._optimize(this._objective)}removeConstraint(t){let e=this._cnMap.erase(t);if(e===void 0)throw new Error("unknown constraint");this._removeConstraintEffects(t,e.second);let r=e.second.marker,i=this._rowMap.erase(r);if(i===void 0){let s=this._getMarkerLeavingSymbol(r);if(s.type()===c.Invalid)throw new Error("failed to find leaving row");i=this._rowMap.erase(s),i.second.solveForEx(s,r),this._substitute(r,i.second)}this._optimize(this._objective)}hasConstraint(t){return this._cnMap.contains(t)}getConstraints(){return this._cnMap.array.map(({first:t})=>t)}addEditVariable(t,e){if(this._editMap.find(t)!==void 0)throw new Error("duplicate edit variable");if(e=p.clip(e),e===p.required)throw new Error("bad required strength");let i=new d(t),s=new x(i,w.Eq,void 0,e);this.addConstraint(s);let a={tag:this._cnMap.find(s).second,constraint:s,constant:0};this._editMap.insert(t,a)}removeEditVariable(t){let e=this._editMap.erase(t);if(e===void 0)throw new Error("unknown edit variable");this.removeConstraint(e.second.constraint)}hasEditVariable(t){return this._editMap.contains(t)}suggestValue(t,e){let r=this._editMap.find(t);if(r===void 0)throw new Error("unknown edit variable");let i=this._rowMap,s=r.second,n=e-s.constant;s.constant=e;let a=s.tag.marker,l=i.find(a);if(l!==void 0){l.second.add(-n)<0&&this._infeasibleRows.push(a),this._dualOptimize();return}let h=s.tag.other;if(l=i.find(h),l!==void 0){l.second.add(n)<0&&this._infeasibleRows.push(h),this._dualOptimize();return}for(let f=0,u=i.size();f<u;++f){let m=i.itemAt(f),M=m.second,b=M.coefficientFor(a);b!==0&&M.add(n*b)<0&&m.first.type()!==c.External&&this._infeasibleRows.push(m.first)}this._dualOptimize()}updateVariables(){let t=this._varMap,e=this._rowMap;for(let r=0,i=t.size();r<i;++r){let s=t.itemAt(r),n=e.find(s.second);n!==void 0?s.first.setValue(n.second.constant()):s.first.setValue(0)}}_getVarSymbol(t){let e=()=>this._makeSymbol(c.External);return this._varMap.setDefault(t,e).second}_createRow(t){let e=t.expression(),r=new z(e.constant()),i=e.terms();for(let l=0,h=i.size();l<h;++l){let f=i.itemAt(l);if(!k(f.second)){let u=this._getVarSymbol(f.first),m=this._rowMap.find(u);m!==void 0?r.insertRow(m.second,f.second):r.insertSymbol(u,f.second)}}let s=this._objective,n=t.strength(),a={marker:y,other:y};switch(t.op()){case w.Le:case w.Ge:{let l=t.op()===w.Le?1:-1,h=this._makeSymbol(c.Slack);if(a.marker=h,r.insertSymbol(h,l),n<p.required){let f=this._makeSymbol(c.Error);a.other=f,r.insertSymbol(f,-l),s.insertSymbol(f,n)}break}case w.Eq:{if(n<p.required){let l=this._makeSymbol(c.Error),h=this._makeSymbol(c.Error);a.marker=l,a.other=h,r.insertSymbol(l,-1),r.insertSymbol(h,1),s.insertSymbol(l,n),s.insertSymbol(h,n)}else{let l=this._makeSymbol(c.Dummy);a.marker=l,r.insertSymbol(l)}break}}return r.constant()<0&&r.reverseSign(),{row:r,tag:a}}_chooseSubject(t,e){let r=t.cells();for(let s=0,n=r.size();s<n;++s){let a=r.itemAt(s);if(a.first.type()===c.External)return a.first}let i=e.marker.type();return(i===c.Slack||i===c.Error)&&t.coefficientFor(e.marker)<0?e.marker:(i=e.other.type(),(i===c.Slack||i===c.Error)&&t.coefficientFor(e.other)<0?e.other:y)}_addWithArtificialVariable(t){let e=this._makeSymbol(c.Slack);this._rowMap.insert(e,t.copy()),this._artificial=t.copy(),this._optimize(this._artificial);let r=k(this._artificial.constant());this._artificial=null;let i=this._rowMap.erase(e);if(i!==void 0){let n=i.second;if(n.isConstant())return r;let a=this._anyPivotableSymbol(n);if(a.type()===c.Invalid)return!1;n.solveForEx(e,a),this._substitute(a,n),this._rowMap.insert(a,n)}let s=this._rowMap;for(let n=0,a=s.size();n<a;++n)s.itemAt(n).second.removeSymbol(e);return this._objective.removeSymbol(e),r}_substitute(t,e){let r=this._rowMap;for(let i=0,s=r.size();i<s;++i){let n=r.itemAt(i);n.second.substitute(t,e),n.second.constant()<0&&n.first.type()!==c.External&&this._infeasibleRows.push(n.first)}this._objective.substitute(t,e),this._artificial&&this._artificial.substitute(t,e)}_optimize(t){let e=0;for(;e<this.maxIterations;){let r=this._getEnteringSymbol(t);if(r.type()===c.Invalid)return;let i=this._getLeavingSymbol(r);if(i.type()===c.Invalid)throw new Error("the objective is unbounded");let s=this._rowMap.erase(i).second;s.solveForEx(i,r),this._substitute(r,s),this._rowMap.insert(r,s),e++}throw new Error("solver iterations exceeded")}_dualOptimize(){let t=this._rowMap,e=this._infeasibleRows;for(;e.length!==0;){let r=e.pop(),i=t.find(r);if(i!==void 0&&i.second.constant()<0){let s=this._getDualEnteringSymbol(i.second);if(s.type()===c.Invalid)throw new Error("dual optimize failed");let n=i.second;t.erase(r),n.solveForEx(r,s),this._substitute(s,n),t.insert(s,n)}}}_getEnteringSymbol(t){let e=t.cells();for(let r=0,i=e.size();r<i;++r){let s=e.itemAt(r),n=s.first;if(s.second<0&&n.type()!==c.Dummy)return n}return y}_getDualEnteringSymbol(t){let e=Number.MAX_VALUE,r=y,i=t.cells();for(let s=0,n=i.size();s<n;++s){let a=i.itemAt(s),l=a.first,h=a.second;if(h>0&&l.type()!==c.Dummy){let u=this._objective.coefficientFor(l)/h;u<e&&(e=u,r=l)}}return r}_getLeavingSymbol(t){let e=Number.MAX_VALUE,r=y,i=this._rowMap;for(let s=0,n=i.size();s<n;++s){let a=i.itemAt(s),l=a.first;if(l.type()!==c.External){let h=a.second,f=h.coefficientFor(t);if(f<0){let u=-h.constant()/f;u<e&&(e=u,r=l)}}}return r}_getMarkerLeavingSymbol(t){let e=Number.MAX_VALUE,r=e,i=e,s=y,n=s,a=s,l=s,h=this._rowMap;for(let f=0,u=h.size();f<u;++f){let m=h.itemAt(f),M=m.second,b=M.coefficientFor(t);if(b===0)continue;let g=m.first;if(g.type()===c.External)l=g;else if(b<0){let v=-M.constant()/b;v<r&&(r=v,n=g)}else{let v=M.constant()/b;v<i&&(i=v,a=g)}}return n!==s?n:a!==s?a:l}_removeConstraintEffects(t,e){e.marker.type()===c.Error&&this._removeMarkerEffects(e.marker,t.strength()),e.other.type()===c.Error&&this._removeMarkerEffects(e.other,t.strength())}_removeMarkerEffects(t,e){let r=this._rowMap.find(t);r!==void 0?this._objective.insertRow(r.second,-e):this._objective.insertSymbol(t,-e)}_anyPivotableSymbol(t){let e=t.cells();for(let r=0,i=e.size();r<i;++r){let s=e.itemAt(r),n=s.first.type();if(n===c.Slack||n===c.Error)return s.first}return y}_makeSymbol(t){return new A(t,this._idTick++)}_cnMap=F();_rowMap=I();_varMap=L();_editMap=R();_infeasibleRows=[];_objective=new z;_artificial=null;_idTick=0};function k(o){let t=1e-8;return o<0?-o<t:o<t}function F(){return _()}function I(){return _()}function L(){return _()}function R(){return _()}var c;(function(o){o[o.Invalid=0]="Invalid",o[o.External=1]="External",o[o.Slack=2]="Slack",o[o.Error=3]="Error",o[o.Dummy=4]="Dummy"})(c||(c={}));var A=class{constructor(t,e){this._id=e,this._type=t}id(){return this._id}type(){return this._type}_id;_type},y=new A(c.Invalid,-1),z=class o{constructor(t=0){this._constant=t}cells(){return this._cellMap}constant(){return this._constant}isConstant(){return this._cellMap.empty()}allDummies(){let t=this._cellMap;for(let e=0,r=t.size();e<r;++e)if(t.itemAt(e).first.type()!==c.Dummy)return!1;return!0}copy(){let t=new o(this._constant);return t._cellMap=this._cellMap.copy(),t}add(t){return this._constant+=t}insertSymbol(t,e=1){let r=this._cellMap.setDefault(t,()=>0);k(r.second+=e)&&this._cellMap.erase(t)}insertRow(t,e=1){this._constant+=t._constant*e;let r=t._cellMap;for(let i=0,s=r.size();i<s;++i){let n=r.itemAt(i);this.insertSymbol(n.first,n.second*e)}}removeSymbol(t){this._cellMap.erase(t)}reverseSign(){this._constant=-this._constant;let t=this._cellMap;for(let e=0,r=t.size();e<r;++e){let i=t.itemAt(e);i.second=-i.second}}solveFor(t){let e=this._cellMap,i=-1/e.erase(t).second;this._constant*=i;for(let s=0,n=e.size();s<n;++s)e.itemAt(s).second*=i}solveForEx(t,e){this.insertSymbol(t,-1),this.solveFor(e)}coefficientFor(t){let e=this._cellMap.find(t);return e!==void 0?e.second:0}substitute(t,e){let r=this._cellMap.erase(t);r!==void 0&&this.insertRow(e,r.second)}_cellMap=_();_constant};export{x as Constraint,d as Expression,w as Operator,D as Solver,p as Strength,E as Variable};
//# sourceMappingURL=kiwi.bundle.mjs.map