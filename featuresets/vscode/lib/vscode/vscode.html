<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../../vscode/out/vs/workbench/workbench.web.main.internal.css" />
</head>
<body style="margin:0;overflow:hidden;">
<script src="../../vscode/out/vs/loader.js"></script>
<script>
    const baseUrl = new URL('../../vscode/out', window.location.href).toString();
    require.config({baseUrl});
</script>
<script src="../../vscode/out/nls.messages.js"></script>
<script src="../../vscode/out/vs/workbench/workbench.web.main.js"></script>
<script type="module">
    const url = new URL('./', window.location.href);
    const scheme = url.protocol.replace(":", "");
    function createWorkbench(port) {
        require(['vs/workbench/workbench.web.main'], function (wb) {
            const config = {
                messagePorts: new Map([["substrateos.system", port]]),
                productConfiguration: {
                    extensionEnabledApiProposals: {"substrateos.system": ["ipc", "extensionRuntime", "textSearchProvider", "fileSearchProvider"]},
                },
                configurationDefaults: {
                    "window.commandCenter": false,
                    "workbench.secondarySideBar.defaultVisibility": "hidden",
                    "workbench.layoutControl.enabled": false,
                    "workbench.startupEditor": "none",
                    "workbench.tips.enabled": false,
                    "workbench.welcomePage.walkthroughs.openOnInstall": false
                },
                developmentOptions: {
                    logLevel: 3
                },
                additionalBuiltinExtensions: [
                    {
                        scheme,
                        authority: url.host,
                        path: `${url.pathname}/extensions/system`,
                    }
                ],
                folderUri: { scheme: "synth", path: "/" },
            }

            wb.create(document.body, {
                ...config,
                workspaceProvider: {
                    trusted: true,
                    workspace: { folderUri: wb.URI.revive(config.folderUri) },
                    async open(workspace, options) {
                        console.log("openFolder requested", workspace);
                        return true;
                    }
                }
            });
        })
    }

    window.addEventListener('message', (event) => {
        if (event.origin !== window.location.origin || event.source !== window.parent) {
            return;
        }

        // Only handle the 'init-port' message
        if (event.data.type !== 'init-port') {
            return;
        }
        
        const extensionPort = event.ports[0];

        if (!extensionPort) {
            console.error("iframe: 'init-port' message received, but no port was transferred.");
            return;
        }

        console.log("iframe: 'init-port' message received, creating workbench.");
        createWorkbench(extensionPort)
    }, {once: true})
</script>
</body>
</html>
